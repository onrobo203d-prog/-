<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¿ã‚¤ãƒãƒ¼&ã‚µã‚¤ã‚³ãƒ­</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f5f5f5;
}
.notice {
  text-align: center;
  font-weight: bold;
  color: #c00;
  padding: 8px;
}
.sound-init {
  text-align: center;
  margin-bottom: 4px;
}
.container {
  height: calc(100vh - 90px);
  display: flex;
  flex-direction: column;
}
.timer-area {
  display: flex;
  gap: 10px;
  padding: 10px;
}
.timer-box {
  flex: 1;
  background: #fff;
  border-radius: 12px;
  padding: 10px;
  text-align: center;
}
.timer-title {
  font-weight: bold;
}
.timer-input {
  width: 80px;
  font-size: 16px;
  text-align: center;
}
.time-display {
  font-size: 28px;
  margin: 6px 0;
}
.button-row {
  display: flex;
  justify-content: center;
  gap: 8px;
}
button {
  padding: 6px 12px;
  font-size: 15px;
}
.dice-area {
  flex: 1;
  background: #fff;
  margin: 10px;
  border-radius: 12px;
  text-align: center;
  padding: 20px;
}
.dice-box {
  width: 120px;
  height: 120px;
  margin: 20px auto;
  border-radius: 16px;
  border: 4px solid #333;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: bold;
}
.rolling {
  animation: shake 0.15s infinite;
}
@keyframes shake {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(2deg); }
  50% { transform: rotate(0deg); }
  75% { transform: rotate(-2deg); }
  100% { transform: rotate(0deg); }
}
</style>
</head>

<body>

<div class="notice">â€» é…ä¿¡å‰ã«ã€ŒéŸ³ã‚’æœ‰åŠ¹åŒ–ã€ã‚’å¿…ãšæŠ¼ã—ã¦ãã ã•ã„ â€»</div>

<div class="sound-init">
  <button id="soundBtn" onclick="enableSound()">ğŸ”Š éŸ³ã‚’æœ‰åŠ¹åŒ–</button>
</div>

<div class="container">

  <div class="timer-area">
    <div class="timer-box">
      <div class="timer-title">â± ã‚¿ã‚¤ãƒãƒ¼â‘ </div>
      <input type="number" id="input1" class="timer-input" placeholder="ç§’"> ç§’
      <div id="display1" class="time-display">0:00</div>
      <div class="button-row">
        <button onclick="startTimer(1)">â–¶</button>
        <button onclick="resetTimer(1)">âŸ²</button>
      </div>
    </div>

    <div class="timer-box">
      <div class="timer-title">â± ã‚¿ã‚¤ãƒãƒ¼â‘¡</div>
      <input type="number" id="input2" class="timer-input" placeholder="ç§’"> ç§’
      <div id="display2" class="time-display">0:00</div>
      <div class="button-row">
        <button onclick="startTimer(2)">â–¶</button>
        <button onclick="resetTimer(2)">âŸ²</button>
      </div>
    </div>
  </div>

  <div class="dice-area">
    <div class="timer-title">ğŸ² ã‚µã‚¤ã‚³ãƒ­</div>
    <div id="dice" class="dice-box">?</div>
    <button onclick="rollDice()">å›ã™ï¼</button>
  </div>

</div>

<script>
let audioCtx;
let silentOsc;
let timers = {};
let soundEnabled = false;

/* ---------- éŸ³æœ‰åŠ¹åŒ–ï¼ˆæœ€é‡è¦ï¼‰ ---------- */
async function enableSound() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state !== 'running') {
    await audioCtx.resume();
  }

  // ğŸ”‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œä¸­ã«ã€Œèã“ãˆã‚‹éŸ³ã€ã‚’1å›é³´ã‚‰ã™
  const clickOsc = audioCtx.createOscillator();
  const clickGain = audioCtx.createGain();
  clickOsc.frequency.value = 800;
  clickGain.gain.value = 0.2;
  clickOsc.connect(clickGain).connect(audioCtx.destination);
  clickOsc.start();
  clickOsc.stop(audioCtx.currentTime + 0.05);

  // ç„¡éŸ³ãƒ«ãƒ¼ãƒ—ã§ Context ã‚’ç¶­æŒ
  if (!silentOsc) {
    const gain = audioCtx.createGain();
    gain.gain.value = 0.0001;
    silentOsc = audioCtx.createOscillator();
    silentOsc.frequency.value = 440;
    silentOsc.connect(gain).connect(audioCtx.destination);
    silentOsc.start();
  }

  soundEnabled = true;
  document.querySelector('.notice').textContent =
    'ğŸ”Š éŸ³ã¯æœ‰åŠ¹ã§ã™ï¼ˆã“ã®ã¾ã¾é…ä¿¡é–‹å§‹OKï¼‰';
  document.getElementById('soundBtn').style.display = 'none';
}

/* ---------- iOSå¾©å¸°å¯¾ç­– ---------- */
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && audioCtx?.state !== 'running') {
    audioCtx.resume();
  }
});

/* ---------- åŠ¹æœéŸ³ ---------- */
function playTimerSound() {
  let t = audioCtx.currentTime;
  for (let i = 0; i < 8; i++) {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'square';
    o.frequency.value = 1000;
    g.gain.setValueAtTime(0.001, t);
    g.gain.linearRampToValueAtTime(0.25, t + 0.02);
    g.gain.linearRampToValueAtTime(0.001, t + 0.15);
    o.connect(g).connect(audioCtx.destination);
    o.start(t);
    o.stop(t + 0.15);
    t += 0.18;
  }
}

function playDiceSound() {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'triangle';
  o.frequency.setValueAtTime(300, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.3);
  g.gain.setValueAtTime(0.001, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.5, audioCtx.currentTime + 0.05);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.6);
  o.connect(g).connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.6);
}

/* ---------- æ™‚é–“è¡¨ç¤º ---------- */
function format(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${s.toString().padStart(2, '0')}`;
}

/* ---------- ã‚¿ã‚¤ãƒãƒ¼ ---------- */
function startTimer(n) {
  if (!soundEnabled) {
    document.querySelector('.notice').textContent =
      'âš  å…ˆã«ã€ŒéŸ³ã‚’æœ‰åŠ¹åŒ–ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„';
    return;
  }

  const input = document.getElementById('input' + n);
  const display = document.getElementById('display' + n);
  const total = Number(input.value);
  if (!total) return;

  const start = performance.now();
  clearInterval(timers[n]);

  timers[n] = setInterval(() => {
    const elapsed = Math.floor((performance.now() - start) / 1000);
    const remain = Math.max(0, total - elapsed);
    display.textContent = format(remain);
    if (remain <= 0) {
      clearInterval(timers[n]);
      playTimerSound();
    }
  }, 250);
}

function resetTimer(n) {
  clearInterval(timers[n]);
  document.getElementById('display' + n).textContent = '0:00';
}

/* ---------- ã‚µã‚¤ã‚³ãƒ­ ---------- */
function rollDice() {
  if (!soundEnabled) {
    document.querySelector('.notice').textContent =
      'âš  å…ˆã«ã€ŒéŸ³ã‚’æœ‰åŠ¹åŒ–ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„';
    return;
  }

  const dice = document.getElementById('dice');
  dice.classList.add('rolling');

  const r = setInterval(() => {
    dice.textContent = Math.floor(Math.random() * 6) + 1;
  }, 100);

  setTimeout(() => {
    clearInterval(r);
    dice.textContent = Math.floor(Math.random() * 6) + 1;
    dice.classList.remove('rolling');
    playDiceSound();
  }, 3000);
}
</script>

</body>
</html>
