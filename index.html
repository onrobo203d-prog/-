<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ガチャツール 完全版</title>
<style>
html,body{margin:0;padding:0;font-family:Arial,sans-serif;background:#fafafa;}
#mainWrapper{padding:15px;}
.section{background:#fff;padding:15px;margin-bottom:15px;border-radius:10px;box-shadow:0 0 4px rgba(0,0,0,0.1);position:relative;}
input,select{width:95%;padding:8px;margin:5px 0;border-radius:5px;border:1px solid #aaa;font-size:14px;box-sizing:border-box;}
button{cursor:pointer;border:none;border-radius:6px;}
.add-btn{margin-top:10px;padding:8px 15px;background:#55aaff;color:#fff;}
.gacha-btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
.gacha-btns button{flex:1;min-width:30%;padding:12px;font-size:16px;background:#ffb34d;color:#fff;}
.preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
.preset-grid button{padding:14px;font-size:16px;background:#7aa8ff;color:#fff;width:100%;text-align:center;}
.custom-save-wrap{position:absolute;top:8px;right:8px;display:flex;flex-direction:column;gap:8px;}
.custom-save-wrap button{padding:6px 10px;font-size:12px;background:#6666ff;color:#fff;}
.copy-btn{margin-top:5px;padding:6px 12px;background:#66cc66;color:#fff;}
.clear-btn{margin-top:10px;padding:10px 15px;background:#ff6666;color:#fff;}
.save-btn{margin-top:10px;padding:10px 15px;background:#6666ff;color:#fff;}
.N{color:#00ccff;} .R{color:#0055ff;} .SR{color:#aa00ff;} .UR{color:#ff55aa;} .LR{color:#ff0000;}
#logContainer{display:flex;flex-direction:column;gap:15px;}
#summary,#log{background:#f8f8f8;padding:10px;border-radius:8px;max-height:500px;overflow:auto;}
.log-block{margin-bottom:10px;border-bottom:1px solid #ccc;padding-bottom:5px;}
.old-log{display:none;font-size:0.9em;color:#333;}
pre{white-space:pre-wrap;word-break:keep-all;}
</style>
</head>
<body>
<div id="mainWrapper">

<div class="section">
<label>確率プリセット</label>
<div class="preset-grid" id="presetGrid">
<button onclick="setPreset('normal')">通常</button>
<button onclick="setPreset('hard')">キツめ</button>
<button onclick="setPreset('veryhard')">極悪</button>
<button onclick="setPreset('hell')">地獄</button>
<button id="loadCustom1Btn" onclick="loadCustom(1)">カスタム1</button>
<button id="loadCustom2Btn" onclick="loadCustom(2)">カスタム2</button>
</div>
</div>

<div class="section">
<label><input type="checkbox" id="ceilingSwitch" onchange="toggleCeiling()"> 天井機能を有効にする</label>
<div id="ceilingSettings" style="display:none;margin-top:10px;">
<label>天井規定回数：<input type="number" id="ceilingCount" value="10"></label><br>
<label>天井対象レアリティ：</label><br>
<select id="ceilingRarity" multiple style="width:95%;height:80px;">
<option value="N" selected>N</option>
<option value="R" selected>R</option>
<option value="SR" selected>SR</option>
<option value="UR" selected>UR</option>
<option value="LR" selected>LR</option>
</select>
</div>
</div>

<div class="section" style="position:relative;">
<label><b>選択中プリセット：</b> <span id="presetName">通常</span></label>
<div class="custom-save-wrap">
<button id="saveCustom1Btn">カスタム保存1</button>
<button id="saveCustom2Btn">カスタム保存2</button>
</div>
<br><br>
<label>カスタム確率設定（%）</label><br>
N <input id="rateN" type="number" value="40"><br>
R <input id="rateR" type="number" value="30"><br>
SR <input id="rateSR" type="number" value="20"><br>
UR <input id="rateUR" type="number" value="7"><br>
LR <input id="rateLR" type="number" value="3"><br>
<button id="customBtn" style="margin-top:10px;">カスタム</button>
</div>

<div class="section" id="itemSection">
<label>景品登録</label>
<div id="items"></div>
<button class="add-btn" onclick="addItem()">＋ 景品追加</button>
</div>

<div class="section">
<label>ガチャを回す人：</label><br>
<input id="playerName" type="text" placeholder="名前を入力">
<button class="add-btn" onclick="addPlayer()">名前を追加</button><br>
<label>下から選択：</label>
<select id="playerSelect"></select>
</div>

<div class="section">
<label>ガチャを回す</label><br>
<div class="gacha-btns">
<button onclick="roll(1)">1回</button>
<button onclick="roll(5)">5回</button>
<button onclick="roll(10)">10回</button>
</div>
<input id="customRoll" type="number" placeholder="任意の回数">
<button style="margin-top:10px;width:100%;padding:10px;" onclick="rollCustom()">この回数で回す</button>
</div>

<div class="section">
<label>ガチャ結果ログ</label><br>
<label>名前で絞り込み：</label>
<select id="logFilter" onchange="displayLog()"></select>
<label>表示順：</label>
<select id="sortOrder" onchange="displayLog()">
<option value="desc" selected>新しい順</option>
<option value="asc">古い順</option>
</select>
<div id="logControls">
<button class="clear-btn" onclick="clearLog()" style="margin-right:10px;">全ログ消去</button>
<button class="save-btn" onclick="saveLog()">ログをtxt保存</button>
</div>
<div id="logContainer">
<div id="log"></div>
<div id="summary"></div>
</div>
</div>

<div class="section">
<button class="save-btn" onclick="saveSettings()">設定を保存</button>
<input type="file" id="loadSettingsFile" style="margin-top:10px;" onchange="loadSettings(this.files)">
</div>

</div>

<script>
let players=[],logData=[],ceilingCounter={},customRates1=null,customRates2=null;
addItem();

function addPlayer(){
  const name=document.getElementById("playerName").value.trim();
  if(!name||players.includes(name)) return;
  players.push(name); ceilingCounter[name]=0; updatePlayerUI();
  document.getElementById("playerName").value="";
}
function updatePlayerUI(){
  const sel=document.getElementById("playerSelect"),filter=document.getElementById("logFilter");
  sel.innerHTML=""; filter.innerHTML='<option value="">全員</option>';
  players.forEach(name=>{
    sel.add(new Option(name,name));
    filter.add(new Option(name,name));
  });
}

function addItem(){
  const div=document.createElement("div");
  div.style.marginTop='8px';
  div.innerHTML=`<input type="text" placeholder="景品名">
<select><option>N</option><option>R</option><option>SR</option><option>UR</option><option>LR</option></select>
<button onclick="this.parentNode.remove()">×</button>`;
  document.getElementById('items').appendChild(div);
  const input=div.querySelector("input"),select=div.querySelector("select");
  input.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();select.focus();}});
}

const presets={
normal:{N:40,R:30,SR:20,UR:7,LR:3},
hard:{N:60,R:25,SR:10,UR:4,LR:1},
veryhard:{N:70,R:20,SR:8,UR:1.5,LR:0.5},
hell:{N:79.9,R:19,SR:1,UR:0.9,LR:0.1}
};
function setPreset(type){
  const p=presets[type]; if(!p) return;
  Object.keys(p).forEach(k=>document.getElementById('rate'+k).value=p[k]);
  document.getElementById("presetName").textContent={"normal":"通常","hard":"キツめ","veryhard":"極悪","hell":"地獄"}[type]||"プリセット";
}

function saveCustom(num){
  const rates={};
  ['N','R','SR','UR','LR'].forEach(k=>rates[k]=parseFloat(document.getElementById('rate'+k).value));
  if(num===1){customRates1=rates;document.getElementById("presetName").textContent="カスタム1";}
  else{customRates2=rates;document.getElementById("presetName").textContent="カスタム2";}
  alert("カスタム"+num+"に保存しました");
}
document.getElementById("saveCustom1Btn").onclick=()=>saveCustom(1);
document.getElementById("saveCustom2Btn").onclick=()=>saveCustom(2);

function loadCustom(num){
  const rates=num===1?customRates1:customRates2;
  if(!rates){alert("保存されたカスタム"+num+"がありません"); return;}
  Object.keys(rates).forEach(k=>document.getElementById('rate'+k).value=rates[k]);
  document.getElementById("presetName").textContent="カスタム"+num;
}

document.getElementById("customBtn").onclick=()=>{
  if(customRates1) loadCustom(1);
  else if(customRates2) loadCustom(2);
  else alert("保存されたカスタムがありません");
};

function toggleCeiling(){document.getElementById("ceilingSettings").style.display=document.getElementById("ceilingSwitch").checked?"block":"none";}

function roll(times){
  const player=document.getElementById("playerSelect").value;
  if(!player){alert("名前を選択してください");return;}
  const items=document.querySelectorAll("#items > div");
  const pool={N:[],R:[],SR:[],UR:[],LR:[]};
  items.forEach(n=>{
    let name=n.querySelector("input").value.trim(),rarity=n.querySelector("select").value;
    if(name) pool[rarity].push(name);
  });
  const rates={};
  ['N','R','SR','UR','LR'].forEach(k=>rates[k]=parseFloat(document.getElementById('rate'+k).value)||0);
  const ceilingOn=document.getElementById("ceilingSwitch").checked;
  const ceilingLimit=parseInt(document.getElementById("ceilingCount").value)||0;
  const ceilingRarities=[...document.getElementById("ceilingRarity").selectedOptions].map(o=>o.value);
  const results=[];
  for(let i=0;i<times;i++){
    let isCeiling=false;
    if(ceilingOn && ceilingCounter[player]+1>=ceilingLimit){isCeiling=true;ceilingCounter[player]=0;}
    else ceilingCounter[player]=(ceilingCounter[player]||0)+1;
    let pick;
    if(isCeiling){
      const ceilingPool=[];
      ceilingRarities.forEach(r=>{if(pool[r]) ceilingPool.push(...pool[r].map(n=>({name:n,rarity:r})));});
      pick=ceilingPool.length===0?{name:"指定レアリティの景品が見当たりません",rarity:"",ceiling:true}:ceilingPool[Math.floor(Math.random()*ceilingPool.length)];
      pick.ceiling=true;
    }else{
      const keys=[],weights=[];
      for(let r in rates){if(pool[r]&&pool[r].length>0){keys.push(r);weights.push(rates[r]);}}
      if(keys.length===0){results.push({name:"景品が登録されていません",rarity:"",ceiling:false});continue;}
      const sum=weights.reduce((a,b)=>a+b,0); let r=Math.random()*sum;
      let sel=keys[0]; for(let i=0;i<keys.length;i++){if(r<weights[i]){sel=keys[i];break;} r-=weights[i];}
      pick={name:pool[sel][Math.floor(Math.random()*pool[sel].length)],rarity:sel};
    }
    results.push(pick);
  }
  logData.push({player,results,times}); displayLog();
}
function rollCustom(){const n=parseInt(document.getElementById("customRoll").value); if(n>0) roll(n);}

function displayLog(){
  const filter=document.getElementById("logFilter").value;
  const sortOrder=document.getElementById("sortOrder").value;
  const logDiv=document.getElementById("log"),summaryDiv=document.getElementById("summary");
  logDiv.innerHTML=""; summaryDiv.innerHTML="";
  let logs=logData.filter(e=>filter===""||e.player===filter);
  if(sortOrder==="desc") logs=logs.slice().reverse();
  const totalSummary={},rarityOrder=["N","R","SR","UR","LR"];
  logs.forEach(entry=>{
    const ceilingItems=entry.results.filter(r=>r.ceiling),normalItems=entry.results.filter(r=>!r.ceiling);
    const normalCount={};
    normalItems.forEach(r=>{const key=r.rarity?`【${r.rarity}】${r.name}`:r.name; normalCount[key]=(normalCount[key]||0)+1; totalSummary[key]=(totalSummary[key]||0)+1;});
    ceilingItems.forEach(r=>{const key=r.rarity?`【${r.rarity}】${r.name}`:r.name; totalSummary[key]=(totalSummary[key]||0)+1;});
    let logText="";
    rarityOrder.forEach(r=>{for(const [k,v] of Object.entries(normalCount)){if(k.startsWith(`【${r}】`)||(r==="N"&&!k.startsWith("【"))) logText+=`  ${k} ×${v}個\n`;}})
    ceilingItems.forEach(r=>{const key=r.rarity?`【${r.rarity}】${r.name}`:r.name; logText+=`  ${key} (天井) ×1個\n`;});
    logDiv.innerHTML+=`<div class="log-block"><b>${entry.player}（${entry.times}回）</b><pre>${logText}</pre>
    <button class="copy-btn" onclick='navigator.clipboard.writeText(\`${entry.player}(${entry.times}回)\n${logText}\`)'>コピー</button></div>`;
  });
  let sumText=""; rarityOrder.forEach(r=>{Object.entries(totalSummary).forEach(([k,v])=>{if(k.startsWith(`【${r}】`)||(r==="N"&&!k.startsWith("【"))) sumText+=`${k}: ${v}個\n`;});});
  const sumTitle=filter===""?`全員(${logs.reduce((a,b)=>a+b.times,0)}回)`${filter}: `${filter}(${logs.reduce((a,b)=>a+b.times,0)}回)`;
  summaryDiv.innerHTML=`<b>集計結果（${sumTitle}）</b><br><pre>${sumText}</pre>
  <button class="copy-btn" onclick='navigator.clipboard.writeText(\`${sumTitle}\n${sumText}\`)'>コピー</button>
  <button class="save-btn" onclick='saveSummary(\`${sumTitle}\n${sumText}\`)'>txt保存</button>`;
}

function clearLog(){if(confirm("全ログと登録名を削除しますか？")){logData=[];players=[];ceilingCounter={};updatePlayerUI();displayLog();}}
function saveLog(){let all=""; logData.forEach(entry=>{const ceilingItems=entry.results.filter(r=>r.ceiling),normalItems=entry.results.filter(r=>!r.ceiling); const normalCount={}; normalItems.forEach(r=>{const key=r.rarity?`【${r.rarity}】${r.name}`:r.name; normalCount[key]=(normalCount[key]||0)+1;}); const rarityOrder=["N","R","SR","UR","LR"]; let txt=""; rarityOrder.forEach(r=>{for(const [k,v] of Object.entries(normalCount)){if(k.startsWith(`【${r}】`)||(r==="N"&&!k.startsWith("【"))) txt+=`${k} ×${v}個\n`;}}); ceilingItems.forEach(r=>{const key=r.rarity?`【${r.rarity}】${r.name}`:r.name; txt+=`${key} (天井) ×1個\n`;}); all+=`${entry.player}(${entry.times}回)\n${txt}\n\n`;}); const blob=new Blob([all],{type:"text/plain"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="gacha_log.txt"; a.click(); URL.revokeObjectURL(url);}
function saveSummary(text){const blob=new Blob([text],{type:"text/plain"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="gacha_summary.txt"; a.click(); URL.revokeObjectURL(url);}

document.getElementById("playerName").addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();addPlayer();}});
updatePlayerUI();
displayLog();
</script>
</body>
</html>
