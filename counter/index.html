<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grid Panel Reveal Builder</title>
<style>
body{margin:0;font-family:sans-serif;text-align:center;background:#f2f2f2}
.controls{margin:10px}
canvas{background:#999;max-width:95vw;touch-action:none}
button,input{margin:4px}
</style>
</head>
<body>

<h2>Grid Panel Reveal</h2>

<div class="controls">
横 <input type="number" id="cols" value="4" min="1">
縦 <input type="number" id="rows" value="4" min="1">
合計 <span id="total">16</span> 枚
<button id="build">グリッド生成</button>
</div>

<div class="controls">
<button id="modeBtn">▶ プレイ</button>
<button id="undoBtn">↩ 戻る</button>
<button id="previewBtn">プレビュー出力</button>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let img = new Image();

let cols=4, rows=4;
let vLines=[], hLines=[];
let panels=[];
let undoStack=[];
let mode="edit";

const LINE_HIT=8;
const MIN_SIZE=20;
const MAX=800;

document.getElementById("cols").oninput =
document.getElementById("rows").oninput = ()=>{
  cols=+colsInput.value; rows=+rowsInput.value;
  total.textContent=cols*rows;
};

const colsInput=document.getElementById("cols");
const rowsInput=document.getElementById("rows");
const total=document.getElementById("total");

document.getElementById("build").onclick=()=>initGrid();

img.onload=()=>{
  const r=Math.min(MAX/img.width,MAX/img.height);
  canvas.width=img.width*r;
  canvas.height=img.height*r;
  initGrid();
};

img.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQIW2P8z8BQDwAF/wJ/lKXcZQAAAABJRU5ErkJggg==";

function initGrid(){
  cols=+colsInput.value;
  rows=+rowsInput.value;
  total.textContent=cols*rows;

  vLines=[]; hLines=[]; panels=[]; undoStack=[];
  for(let i=0;i<=cols;i++) vLines.push(canvas.width*i/cols);
  for(let i=0;i<=rows;i++) hLines.push(canvas.height*i/rows);

  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      panels.push({x,y,visible:true});
    }
  }
  draw();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0,canvas.width,canvas.height);

  panels.forEach(p=>{
    if(p.visible){
      const x1=vLines[p.x], x2=vLines[p.x+1];
      const y1=hLines[p.y], y2=hLines[p.y+1];
      ctx.fillStyle="#000";
      ctx.fillRect(x1,y1,x2-x1,y2-y1);
    }
  });

  if(mode==="edit"){
    ctx.strokeStyle="#0ff";
    ctx.lineWidth=2;
    vLines.forEach(x=>{
      ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();
    });
    hLines.forEach(y=>{
      ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();
    });
  }
}

let dragLine=null;

canvas.onpointerdown=e=>{
  if(mode!=="edit") return;
  const r=canvas.getBoundingClientRect();
  const x=(e.clientX-r.left)*(canvas.width/r.width);
  const y=(e.clientY-r.top)*(canvas.height/r.height);

  vLines.forEach((lx,i)=>{
    if(i>0 && i<cols && Math.abs(lx-x)<LINE_HIT) dragLine={type:"v",i};
  });
  hLines.forEach((ly,i)=>{
    if(i>0 && i<rows && Math.abs(ly-y)<LINE_HIT) dragLine={type:"h",i};
  });
};

canvas.onpointermove=e=>{
  if(!dragLine) return;
  const r=canvas.getBoundingClientRect();
  const pos=(dragLine.type==="v"
    ? (e.clientX-r.left)*(canvas.width/r.width)
    : (e.clientY-r.top)*(canvas.height/r.height)
  );
  const arr=dragLine.type==="v"?vLines:hLines;
  const i=dragLine.i;
  arr[i]=Math.max(arr[i-1]+MIN_SIZE,Math.min(arr[i+1]-MIN_SIZE,pos));
  draw();
};

canvas.onpointerup=()=>dragLine=null;

canvas.onclick=e=>{
  if(mode!=="play") return;
  const r=canvas.getBoundingClientRect();
  const x=(e.clientX-r.left)*(canvas.width/r.width);
  const y=(e.clientY-r.top)*(canvas.height/r.height);
  panels.forEach(p=>{
    if(!p.visible) return;
    const x1=vLines[p.x], x2=vLines[p.x+1];
    const y1=hLines[p.y], y2=hLines[p.y+1];
    if(x>x1&&x<x2&&y>y1&&y<y2){
      p.visible=false;
      undoStack.push(p);
      draw();
    }
  });
};

document.getElementById("undoBtn").onclick=()=>{
  const p=undoStack.pop();
  if(p){ p.visible=true; draw(); }
};

document.getElementById("modeBtn").onclick=function(){
  mode=mode==="edit"?"play":"edit";
  this.textContent=mode==="edit"?"▶ プレイ":"✏ 編集";
  draw();
};

document.getElementById("previewBtn").onclick=()=>{
  const out=document.createElement("canvas");
  out.width=canvas.width;
  out.height=canvas.height;
  const o=out.getContext("2d");
  o.drawImage(img,0,0,out.width,out.height);
  panels.forEach(p=>{
    if(p.visible){
      o.fillStyle="#000";
      o.fillRect(vLines[p.x],hLines[p.y],
        vLines[p.x+1]-vLines[p.x],
        hLines[p.y+1]-hLines[p.y]);
    }
  });
  const w=window.open();
  w.document.body.appendChild(out);
};
</script>
</body>
</html>
