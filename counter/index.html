<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Reveal</title>
<style>
body{
  font-family:sans-serif;
  background:#f4f4f4;
  margin:0;
  padding:20px;
  text-align:center;
}
#canvasWrapper{
  margin:40px auto;
  padding:40px;
  background:#ddd;
  display:inline-block;
}
canvas{
  border:1px solid #aaa;
  touch-action:none;
}
.controls{
  margin:10px 0;
}
button{
  margin:5px;
  padding:6px 12px;
}
input[type=color]{
  width:50px;
  height:30px;
  vertical-align:middle;
}
</style>
</head>
<body>

<h2>Panel Reveal Builder</h2>

<div class="controls">
<input type="file" id="upload">
壁色 <input type="color" id="wallColor" value="#000000">
線太さ <input type="range" id="lineWidth" min="2" max="50" value="10">
<button id="splitBtn">パネル分割</button>
<button id="resetBtn">リセット</button>
</div>

<div class="controls">
<button id="modeBtn">編集</button>
<button id="previewBtn">プレビュー出力</button>
<button id="exportBtn">JSON出力</button>
<input type="file" id="importFile" style="display:none">
<button onclick="document.getElementById('importFile').click()">JSON読込</button>
</div>

<div id="canvasWrapper">
<canvas id="canvas" width="1080" height="1080"></canvas>
</div>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

let image=new Image();
let validArea=null;
let drawing=false;
let lines=[];
let panels=[];
let mode="edit";

const wallColorInput=document.getElementById("wallColor");
const lineWidthInput=document.getElementById("lineWidth");

function saveLocal(){
 localStorage.setItem("panelData",JSON.stringify({
  lines,panels,validArea,imageSrc:image.src
 }));
}

function loadLocal(){
 const data=localStorage.getItem("panelData");
 if(!data)return false;
 const obj=JSON.parse(data);
 lines=obj.lines||[];
 panels=obj.panels||[];
 validArea=obj.validArea;
 image.src=obj.imageSrc;
 image.onload=()=>drawAll();
 return true;
}

if(loadLocal()){
 if(confirm("前回のデータを復旧しますか？")==false){
  localStorage.removeItem("panelData");
 }
}

document.getElementById("upload").onchange=e=>{
 const file=e.target.files[0];
 const reader=new FileReader();
 reader.onload=ev=>{
  image.src=ev.target.result;
 };
 reader.readAsDataURL(file);
};

image.onload=()=>{
 const ratio=Math.min(1080/image.width,1080/image.height);
 const w=image.width*ratio;
 const h=image.height*ratio;
 validArea={
  x:(1080-w)/2,
  y:(1080-h)/2,
  width:w,
  height:h
 };
 lines=[];
 panels=[];
 drawAll();
 saveLocal();
};

function drawAll(){
 ctx.clearRect(0,0,1080,1080);
 ctx.fillStyle="#999";
 ctx.fillRect(0,0,1080,1080);

 if(validArea){
  ctx.drawImage(image,validArea.x,validArea.y,validArea.width,validArea.height);
 }

 lines.forEach(line=>{
  ctx.strokeStyle=line.color;
  ctx.lineWidth=line.width;
  ctx.beginPath();
  ctx.moveTo(line.points[0].x,line.points[0].y);
  for(let i=1;i<line.points.length;i++){
   ctx.lineTo(line.points[i].x,line.points[i].y);
  }
  ctx.stroke();
 });

 panels.forEach(p=>{
  if(mode==="edit" || !p.unlocked){
   ctx.fillStyle=p.color;
   ctx.fill(p.path);
   if(p.name){
    ctx.fillStyle=p.textColor;
    ctx.font="40px sans-serif";
    ctx.textAlign="center";
    ctx.fillText(p.name,p.cx,p.cy);
   }
  }
 });
}

canvas.addEventListener("pointerdown",e=>{
 if(mode!=="edit"||!validArea)return;
 drawing=true;
 const pos=getPos(e);
 lines.push({
  color:wallColorInput.value,
  width:lineWidthInput.value,
  points:[pos]
 });
});

canvas.addEventListener("pointermove",e=>{
 if(!drawing)return;
 const pos=getPos(e);
 lines[lines.length-1].points.push(pos);
 drawAll();
});

canvas.addEventListener("pointerup",()=>{
 drawing=false;
 saveLocal();
});

canvas.addEventListener("click",e=>{
 if(mode!=="play")return;
 const pos=getPos(e);
 panels.forEach(p=>{
  if(ctx.isPointInPath(p.path,pos.x,pos.y)){
   p.unlocked=!p.unlocked;
  }
 });
 drawAll();
 saveLocal();
});

function getPos(e){
 const rect=canvas.getBoundingClientRect();
 const scaleX=1080/rect.width;
 const scaleY=1080/rect.height;
 return{
  x:(e.clientX-rect.left)*scaleX,
  y:(e.clientY-rect.top)*scaleY
 };
}

document.getElementById("splitBtn").onclick=()=>{
 if(!validArea)return;

 const imgData=ctx.getImageData(0,0,1080,1080);
 const data=imgData.data;
 const visited=new Uint8Array(1080*1080);
 panels=[];
 
 function isWall(x,y){
  if(x<validArea.x||x>validArea.x+validArea.width||
     y<validArea.y||y>validArea.y+validArea.height)
   return true;
  const i=(Math.floor(y)*1080+Math.floor(x))*4;
  const r=data[i],g=data[i+1],b=data[i+2];
  const wc=hexToRgb(wallColorInput.value);
  return Math.abs(r-wc.r)<10 &&
         Math.abs(g-wc.g)<10 &&
         Math.abs(b-wc.b)<10;
 }

 for(let y=0;y<1080;y++){
  for(let x=0;x<1080;x++){
   const idx=y*1080+x;
   if(visited[idx]||isWall(x,y))continue;
   const stack=[[x,y]];
   const points=[];
   visited[idx]=1;

   while(stack.length){
    const [sx,sy]=stack.pop();
    points.push([sx,sy]);
    [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dx,dy])=>{
     const nx=sx+dx,ny=sy+dy;
     const nidx=ny*1080+nx;
     if(nx>=0&&ny>=0&&nx<1080&&ny<1080&&!visited[nidx]&&!isWall(nx,ny)){
      visited[nidx]=1;
      stack.push([nx,ny]);
     }
    });
   }

   const path=new Path2D();
   points.forEach(([px,py])=>{
    path.rect(px,py,1,1);
   });

   const cx=points.reduce((a,b)=>a+b[0],0)/points.length;
   const cy=points.reduce((a,b)=>a+b[1],0)/points.length;

   panels.push({
    path,
    color:"#ffffff",
    textColor:"#000000",
    name:"",
    condition:"",
    unlocked:false,
    cx,cy
   });
  }
 }

 drawAll();
 saveLocal();
};

document.getElementById("resetBtn").onclick=()=>{
 if(confirm("リセットしますか？")){
  lines=[];
  panels=[];
  drawAll();
  saveLocal();
 }
};

document.getElementById("modeBtn").onclick=function(){
 if(mode==="edit"){
  mode="play";
  this.textContent="編集";
 }else{
  mode="edit";
  this.textContent="保存";
 }
 drawAll();
 saveLocal();
};

document.getElementById("previewBtn").onclick=()=>{
 const out=document.createElement("canvas");
 out.width=validArea.width;
 out.height=validArea.height;
 const octx=out.getContext("2d");

 octx.drawImage(canvas,
  validArea.x,validArea.y,
  validArea.width,validArea.height,
  0,0,
  validArea.width,validArea.height
 );

 const win=window.open();
 win.document.body.appendChild(out);
};

document.getElementById("exportBtn").onclick=()=>{
 const data=JSON.stringify({lines,panels,validArea,imageSrc:image.src});
 const blob=new Blob([data],{type:"application/json"});
 const url=URL.createObjectURL(blob);
 const a=document.createElement("a");
 a.href=url;
 a.download="panelData.json";
 a.click();
};

document.getElementById("importFile").onchange=e=>{
 const file=e.target.files[0];
 const reader=new FileReader();
 reader.onload=ev=>{
  const obj=JSON.parse(ev.target.result);
  lines=obj.lines;
  panels=obj.panels;
  validArea=obj.validArea;
  image.src=obj.imageSrc;
 };
 reader.readAsText(file);
};

function hexToRgb(hex){
 const bigint=parseInt(hex.slice(1),16);
 return{
  r:(bigint>>16)&255,
  g:(bigint>>8)&255,
  b:bigint&255
 };
}
</script>

</body>
</html>
