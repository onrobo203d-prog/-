<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Panel Mask Builder</title>
<style>
body{margin:0;font-family:sans-serif;background:#f2f2f2}
.controls{padding:8px;text-align:center}
canvas{display:block;margin:auto;max-width:95vw;background:#999;touch-action:none}
input,button,textarea{margin:4px}
textarea{width:90%;max-width:400px}
.panel-ui{border:1px solid #ccc;padding:4px;margin:4px;background:#fff}
</style>
</head>
<body>

<div class="controls">
<input type="file" id="upload"><br>
横 <input type="number" id="cols" value="4" min="1">
縦 <input type="number" id="rows" value="4" min="1">
合計 <span id="total">16</span>
<button id="build">グリッド生成</button><br>
パネル色 <input type="color" id="panelColor" value="#000000">
枠線色 <input type="color" id="lineColor" value="#00ffff">
枠線表示 <input type="checkbox" id="lineVisible" checked><br>
<button id="modeBtn">▶ 再生</button>
<button id="undoBtn">↩ 戻る</button>
<button id="previewBtn">進捗プレビュー</button>
</div>

<canvas id="canvas"></canvas>

<div id="panelTexts"></div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let img = new Image();
let cols=4, rows=4;
let mode="edit";
let MAX=800;

let panels=[];
let undoStack=[];
let dragEdge=null;

document.getElementById("cols").oninput =
document.getElementById("rows").oninput = ()=>{
  total.textContent = colsInput.value * rowsInput.value;
};

const colsInput=document.getElementById("cols");
const rowsInput=document.getElementById("rows");
const total=document.getElementById("total");

document.getElementById("upload").onchange=e=>{
  const r=new FileReader();
  r.onload=ev=>img.src=ev.target.result;
  r.readAsDataURL(e.target.files[0]);
};

img.onload=()=>{
  const r=Math.min(MAX/img.width,MAX/img.height);
  canvas.width=img.width*r;
  canvas.height=img.height*r;
  initGrid();
};

document.getElementById("build").onclick=()=>initGrid();

function initGrid(){
  cols=+colsInput.value;
  rows=+rowsInput.value;
  total.textContent=cols*rows;
  panels=[];
  undoStack=[];
  document.getElementById("panelTexts").innerHTML="";

  const w=canvas.width/cols;
  const h=canvas.height/rows;

  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      panels.push({
        x,y,
        visible:true,
        name:"",
        condition:"",
        edges:{
          top:{dx:0,dy:0},
          right:{dx:0,dy:0},
          bottom:{dx:0,dy:0},
          left:{dx:0,dy:0}
        }
      });
      createTextUI(x,y);
    }
  }
  draw();
}

/* ===== UI ===== */
function createTextUI(x,y){
  const idx=y*cols+x;
  const wrap=document.createElement("div");
  wrap.className="panel-ui";
  wrap.innerHTML=`
    <b>パネル ${idx+1}</b><br>
    名称<br><input data-i="${idx}" data-t="name"><br>
    条件<br><textarea data-i="${idx}" data-t="cond"></textarea>
  `;
  wrap.oninput=e=>{
    const i=e.target.dataset.i;
    if(e.target.dataset.t==="name") panels[i].name=e.target.value;
    if(e.target.dataset.t==="cond") panels[i].condition=e.target.value;
    draw();
  };
  document.getElementById("panelTexts").appendChild(wrap);
}

/* ===== 描画 ===== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(img.src) ctx.drawImage(img,0,0,canvas.width,canvas.height);

  panels.forEach(p=>{
    if(p.visible){
      const path=getPanelPath(p);
      ctx.fillStyle=panelColor.value;
      ctx.fill(path);
      if(lineVisible.checked){
        ctx.strokeStyle=lineColor.value;
        ctx.stroke(path);
      }
      drawText(p,path);
    }
  });
}

function getPanelPath(p){
  const w=canvas.width/cols;
  const h=canvas.height/rows;
  const x0=p.x*w, y0=p.y*h;
  const x1=x0+w, y1=y0+h;
  const path=new Path2D();

  path.moveTo(x0,y0);
  path.quadraticCurveTo(x0+w/2+p.edges.top.dx,y0+p.edges.top.dy,x1,y0);
  path.quadraticCurveTo(x1+p.edges.right.dx,y0+h/2+p.edges.right.dy,x1,y1);
  path.quadraticCurveTo(x0+w/2+p.edges.bottom.dx,y1+p.edges.bottom.dy,x0,y1);
  path.quadraticCurveTo(x0+p.edges.left.dx,y0+h/2+p.edges.left.dy,x0,y0);
  path.closePath();
  return path;
}

function drawText(p,path){
  ctx.save();
  ctx.fillStyle="#fff";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  const w=canvas.width/cols;
  const h=canvas.height/rows;
  const cx=p.x*w+w/2;
  const cy=p.y*h+h/2;
  ctx.font="14px sans-serif";
  if(p.name) ctx.fillText(p.name,cx,cy-10);
  if(p.condition) ctx.fillText(p.condition,cx,cy+10);
  ctx.restore();
}

/* ===== 辺ドラッグ（簡易） ===== */
canvas.onpointerdown=e=>{
  if(mode!=="edit") return;
  const r=canvas.getBoundingClientRect();
  const x=(e.clientX-r.left)*(canvas.width/r.width);
  const y=(e.clientY-r.top)*(canvas.height/r.height);
  panels.forEach(p=>{
    const w=canvas.width/cols;
    const h=canvas.height/rows;
    const cx=p.x*w+w/2;
    const cy=p.y*h+h/2;
    if(Math.abs(y-(p.y*h))<10) dragEdge={p,edge:"top"};
    else if(Math.abs(y-(p.y*h+h))<10) dragEdge={p,edge:"bottom"};
    else if(Math.abs(x-(p.x*w))<10) dragEdge={p,edge:"left"};
    else if(Math.abs(x-(p.x*w+w))<10) dragEdge={p,edge:"right"};
  });
};

canvas.onpointermove=e=>{
  if(!dragEdge) return;
  const r=canvas.getBoundingClientRect();
  const x=(e.clientX-r.left)*(canvas.width/r.width);
  const y=(e.clientY-r.top)*(canvas.height/r.height);
  dragEdge.p.edges[dragEdge.edge].dx = x - (dragEdge.p.x*canvas.width/cols + canvas.width/cols/2);
  dragEdge.p.edges[dragEdge.edge].dy = y - (dragEdge.p.y*canvas.height/rows + canvas.height/rows/2);
  draw();
};

canvas.onpointerup=()=>dragEdge=null;

/* ===== 再生 ===== */
canvas.onclick=e=>{
  if(mode!=="play") return;
  const r=canvas.getBoundingClientRect();
  const x=(e.clientX-r.left)*(canvas.width/r.width);
  const y=(e.clientY-r.top)*(canvas.height/r.height);
  panels.forEach(p=>{
    if(!p.visible) return;
    const path=getPanelPath(p);
    if(ctx.isPointInPath(path,x,y)){
      p.visible=false;
      undoStack.push(p);
      draw();
    }
  });
};

undoBtn.onclick=()=>{
  const p=undoStack.pop();
  if(p){ p.visible=true; draw(); }
};

modeBtn.onclick=function(){
  mode=mode==="edit"?"play":"edit";
  this.textContent=mode==="edit"?"▶ 再生":"✏ 編集";
  draw();
};

previewBtn.onclick=()=>{
  const c=document.createElement("canvas");
  c.width=canvas.width;
  c.height=canvas.height;
  const o=c.getContext("2d");
  o.drawImage(img,0,0,c.width,c.height);
  panels.forEach(p=>{
    if(p.visible){
      o.fillStyle=panelColor.value;
      o.fill(getPanelPath(p));
    }
  });
  const w=window.open();
  w.document.body.appendChild(c);
};
</script>

</body>
</html>
