<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>画像管理サイト</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --card-size: clamp(90px, 10vw, 140px);
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f6f6f6;
}

header {
  display: flex;
  gap: 8px;
  padding: 10px;
}

#search {
  flex: 1;
  padding: 8px;
  font-size: 14px;
}

#exportBtn {
  padding: 8px 12px;
}

#customFilter {
  display: none;
  gap: 6px;
  padding: 0 10px 6px;
}

#customFilter input {
  width: 80px;
  padding: 4px;
  font-size: 12px;
}

#tabs {
  display: flex;
  gap: 6px;
  padding: 0 10px;
  overflow-x: auto;
}

#tabs button {
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  background: #ddd;
  font-size: 13px;
  white-space: nowrap;
}

#tabs button.active {
  background: #222;
  color: #fff;
}

#grid {
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(var(--card-size), 1fr));
  gap: 10px;
}

.card {
  background: #fff;
  border-radius: 8px;
  padding: 6px;
  text-align: center;
  position: relative;
}

.thumb {
  width: 100%;
  aspect-ratio: 1 / 1;
  background: #bbb;
  border-radius: 6px;
  background-size: cover;
  background-position: center;
}

.name {
  font-size: 12px;
}

.point {
  font-size: 11px;
  color: #666;
}

.card.disabled {
  opacity: 0.5;
}

.card.disabled::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(
    45deg,
    transparent 45%,
    rgba(200,0,0,.8) 45%,
    rgba(200,0,0,.8) 55%,
    transparent 55%
  );
  pointer-events: none;
}

#preview {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#previewInner {
  position: relative;
  background: #fff;
  padding: 10px;
  max-width: 95vw;
  max-height: 95vh;
  text-align: center;
}

#previewImg {
  max-width: 100%;
  max-height: 80vh;
  display: block;
  margin: auto;
}

#closePreview {
  position: absolute;
  top: 4px;
  right: 8px;
  font-size: 24px;
  background: none;
  border: none;
}

#prevImg, #nextImg {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 32px;
  background: none;
  border: none;
}

#prevImg { left: -8px; }
#nextImg { right: -8px; }

#pageInfo {
  font-size: 12px;
  margin-bottom: 6px;
}
</style>
</head>

<body>

<header>
  <input id="search" placeholder="検索">
  <button id="exportBtn">画像出力</button>
</header>

<div id="customFilter">
  <span>ポイント範囲：</span>
  <input type="number" id="minPoint" placeholder="最小">
  <span>〜</span>
  <input type="number" id="maxPoint" placeholder="最大">
</div>

<nav id="tabs">
  <button class="active" data-tab="全て">全て</button>
  <button data-tab="ネタ">ネタ</button>
  <button data-tab="笑">笑</button>
  <button data-tab="定番">定番</button>
  <button data-tab="えらい">えらい</button>
  <button data-tab="挨拶">挨拶</button>
  <button data-tab="ステージ">ステージ</button>
  <button data-tab="LOVE">LOVE</button>
  <button data-tab="カスタム">カスタム</button>
</nav>

<main id="grid"></main>

<div id="preview">
  <div id="previewInner">
    <button id="closePreview">×</button>
    <button id="prevImg">‹</button>
    <button id="nextImg">›</button>
    <div id="pageInfo"></div>
    <img id="previewImg">
  </div>
</div>

<script>
const DATA_URL =
  "https://raw.githubusercontent.com/onrobo203d-prog/gifts-image/main/data.json";
const IMG_BASE =
  "https://raw.githubusercontent.com/onrobo203d-prog/gifts-image/main/images/";

let items = [];
let activeTab = "全て";

const grid = document.getElementById("grid");
const search = document.getElementById("search");
const customFilter = document.getElementById("customFilter");
const minPointInput = document.getElementById("minPoint");
const maxPointInput = document.getElementById("maxPoint");

fetch(DATA_URL + "?v=" + Date.now())
  .then(r => r.json())
  .then(data => { items = data; render(); });

function getFiltered(ignoreSearch=false) {
  return items.filter(i => {
    if (!ignoreSearch && !i.name.includes(search.value)) return false;
    if (activeTab === "カスタム") {
      const min = minPointInput.value === "" ? -Infinity : Number(minPointInput.value);
      const max = maxPointInput.value === "" ? Infinity : Number(maxPointInput.value);
      return i.points >= min && i.points <= max;
    }
    if (activeTab === "全て") return true;
    return i.categories.includes(activeTab);
  });
}

function render() {
  grid.innerHTML = "";
  getFiltered().forEach(item => {
    const c = document.createElement("div");
    c.className = "card" + (item.disabled ? " disabled" : "");
    // ここで拡張子 .PNG を付けて表示
    c.innerHTML = `
      <div class="thumb" style="background-image:url(${IMG_BASE + item.id}.PNG?v=${Date.now()})"></div>
      <div class="name">${item.name}</div>
      <div class="point">${item.points}pt</div>
    `;
    c.onclick = () => { item.disabled = !item.disabled; render(); };
    grid.appendChild(c);
  });
}

document.querySelectorAll("#tabs button").forEach(b=>{
  b.onclick = () => {
    document.querySelector("#tabs .active").classList.remove("active");
    b.classList.add("active");
    activeTab = b.dataset.tab;
    customFilter.style.display = activeTab === "カスタム" ? "flex" : "none";
    render();
  };
});

search.oninput = render;
minPointInput.oninput = render;
maxPointInput.oninput = render;

let previewImages = [];
let currentPreviewIndex = 0;

document.getElementById("exportBtn").onclick = () => {
  const list = getFiltered(true);
  if (!list.length) return;

  previewImages = [];
  currentPreviewIndex = 0;
  const MAX_PER_IMAGE = 100;
  for (let i = 0; i < list.length; i += MAX_PER_IMAGE) {
    previewImages.push(generateCanvasImage(list.slice(i, i + MAX_PER_IMAGE)));
  }
  showPreview();
};

function generateCanvasImage(list) {
  const W = 1920, H = 1080;
  const padding = 20;
  const thumbSize = 160;
  const textHeight = 56;
  const cardW = thumbSize + padding * 2;
  const cardH = thumbSize + textHeight + padding * 2;
  const cols = Math.floor(W / cardW);
  const canvas = document.createElement("canvas");
  canvas.width = W;
  canvas.height = H;
  const ctx = canvas.getContext("2d");

  ctx.fillStyle = "#f6f6f6";
  ctx.fillRect(0, 0, W, H);

  list.forEach((item, i) => {
    const col = i % cols;
    const row = Math.floor(i / cols);
    const x = col * cardW + padding;
    const y = row * cardH + padding;

    ctx.fillStyle = "#ccc";
    ctx.fillRect(x, y, thumbSize, thumbSize);

    ctx.fillStyle = "#000";
    ctx.font = "18px sans-serif";
    ctx.fillText(item.name, x, y + thumbSize + 24);
    ctx.font = "14px sans-serif";
    ctx.fillText(item.points + "pt", x, y + thumbSize + 44);

    if (item.disabled) {
      ctx.strokeStyle = "red";
      ctx.lineWidth = 5;
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x + thumbSize, y + thumbSize);
      ctx.stroke();
    }
  });

  return canvas.toDataURL("image/jpeg", 0.85);
}

function showPreview() {
  document.getElementById("previewImg").src = previewImages[currentPreviewIndex];
  document.getElementById("pageInfo").textContent =
    `${currentPreviewIndex + 1} / ${previewImages.length}`;
  document.getElementById("preview").style.display = "flex";
}

document.getElementById("prevImg").onclick = () => {
  if (currentPreviewIndex > 0) { currentPreviewIndex--; showPreview(); }
};
document.getElementById("nextImg").onclick = () => {
  if (currentPreviewIndex < previewImages.length - 1) { currentPreviewIndex++; showPreview(); }
};
document.getElementById("closePreview").onclick = () => {
  document.getElementById("preview").style.display = "none";
};

</script>

</body>
</html>
