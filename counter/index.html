<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>画像管理サイト</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 12px;
  background: #fafafa;
}

header {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
}

#search {
  flex: 1;
  padding: 8px;
  font-size: 14px;
}

#exportBtn {
  padding: 8px 12px;
  font-size: 13px;
}

#tabs {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  margin-bottom: 12px;
}

#tabs button {
  border: none;
  background: #e0e0e0;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 13px;
  white-space: nowrap;
  cursor: pointer;
}

#tabs button.active {
  background: #333;
  color: #fff;
}

/* 表示用 */
#grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(96px, 1fr));
  gap: 10px;
}

/* 出力用ラッパー（普段は非表示） */
#exportArea {
  width: 1280px;
  height: 720px;
  background: #fafafa;
  padding: 16px;
  box-sizing: border-box;
  display: none;
}

#exportGrid {
  display: grid;
  gap: 12px;
}

/* 共通カード */
.card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 6px;
  text-align: center;
  position: relative;
}

.thumb {
  width: 100%;
  aspect-ratio: 1 / 1;
  background: #ccc;
  border-radius: 6px;
  margin-bottom: 4px;
}

.name {
  font-size: 12px;
}

.point {
  font-size: 11px;
  color: #666;
}

.counter {
  margin-top: 6px;
  font-size: 12px;
}

.counter button {
  margin: 0 4px;
}

/* 斜線 */
.card.disabled {
  opacity: 0.5;
}

.card.disabled::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(
    45deg,
    transparent 45%,
    rgba(200,0,0,0.8) 45%,
    rgba(200,0,0,0.8) 55%,
    transparent 55%
  );
  pointer-events: none;
}
</style>
</head>

<body>

<header>
  <input type="text" id="search" placeholder="検索">
  <button id="exportBtn">画像出力</button>
</header>

<nav id="tabs">
  <button class="active" data-tab="全て">全て</button>
  <button data-tab="ネタ">ネタ</button>
  <button data-tab="笑">笑</button>
  <button data-tab="定番">定番</button>
  <button data-tab="えらい">えらい</button>
  <button data-tab="挨拶">挨拶</button>
  <button data-tab="ステージ">ステージ</button>
  <button data-tab="LOVE">LOVE</button>
  <button data-tab="カスタム">カスタム</button>
</nav>

<main id="grid"></main>

<!-- 画像出力専用 -->
<div id="exportArea">
  <div id="exportGrid"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const items = [
  { name:"おつかれ", points:5, categories:["挨拶","定番"], isCustom:true, count:0, disabled:false },
  { name:"すごい", points:10, categories:["えらい"], isCustom:false, count:0, disabled:false },
  { name:"草", points:3, categories:["ネタ","笑"], isCustom:true, count:0, disabled:false },
  { name:"ありがとう", points:8, categories:["挨拶","LOVE"], isCustom:false, count:0, disabled:false }
];

let activeTab = "全て";

const grid = document.getElementById("grid");
const searchInput = document.getElementById("search");
const exportBtn = document.getElementById("exportBtn");
const exportArea = document.getElementById("exportArea");
const exportGrid = document.getElementById("exportGrid");

function getFilteredItems() {
  const keyword = searchInput.value.toLowerCase();
  return items.filter(item => {
    if (!item.name.toLowerCase().includes(keyword)) return false;
    if (activeTab === "全て") return true;
    if (activeTab === "カスタム") return item.isCustom;
    return item.categories.includes(activeTab);
  });
}

function render() {
  grid.innerHTML = "";
  getFilteredItems().forEach(item => {
    const card = document.createElement("div");
    card.className = "card";
    if (item.disabled) card.classList.add("disabled");

    let counterHTML = "";
    if (activeTab === "カスタム") {
      counterHTML = `
        <div class="counter">
          <button class="minus">-</button>
          <span>${item.count}</span>
          <button class="plus">+</button>
        </div>`;
    }

    card.innerHTML = `
      <div class="thumb"></div>
      <div class="name">${item.name}</div>
      <div class="point">${item.points} pt</div>
      ${counterHTML}
    `;

    card.onclick = () => {
      item.disabled = !item.disabled;
      render();
    };

    if (activeTab === "カスタム") {
      card.querySelector(".plus").onclick = e => {
        e.stopPropagation(); item.count++; render();
      };
      card.querySelector(".minus").onclick = e => {
        e.stopPropagation(); if (item.count>0) item.count--; render();
      };
    }

    grid.appendChild(card);
  });
}

// タブ
document.querySelectorAll("#tabs button").forEach(btn => {
  btn.onclick = () => {
    document.querySelector("#tabs .active").classList.remove("active");
    btn.classList.add("active");
    activeTab = btn.dataset.tab;
    render();
  };
});

// 検索
searchInput.oninput = render;

// 画像出力
exportBtn.onclick = async () => {
  const list = getFilteredItems();
  exportGrid.innerHTML = "";

  // 自動列数（最大5列）
  const cols = Math.min(5, Math.ceil(Math.sqrt(list.length || 1)));
  exportGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

  list.forEach(item => {
    const card = document.createElement("div");
    card.className = "card";
    if (item.disabled) card.classList.add("disabled");
    card.innerHTML = `
      <div class="thumb"></div>
      <div class="name">${item.name}</div>
      <div class="point">${item.points} pt</div>
    `;
    exportGrid.appendChild(card);
  });

  exportArea.style.display = "block";

  const canvas = await html2canvas(exportArea, { scale: 1 });
  exportArea.style.display = "none";

  const link = document.createElement("a");
  link.href = canvas.toDataURL("image/jpeg", 0.85); // 5MB以下狙い
  link.download = "status.jpg";
  link.click();
};

render();
</script>

</body>
</html>
