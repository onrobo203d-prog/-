<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Panel Mask – Shared Curve Grid</title>
<style>
body{margin:0;font-family:sans-serif;background:#f2f2f2}
.controls{text-align:center;padding:8px}
canvas{display:block;margin:auto;max-width:95vw;background:#aaa;touch-action:none}
button,input,textarea{margin:4px}
.panel-ui{background:#fff;border:1px solid #ccc;margin:6px;padding:6px}
.panel-ui input,.panel-ui textarea{width:95%}
</style>
</head>
<body>

<div class="controls">
<input type="file" id="upload"><br>
横 <input type="number" id="cols" value="4" min="1">
縦 <input type="number" id="rows" value="4" min="1">
合計 <span id="total">16</span><br>

<button id="panelBuild">パネル生成</button>
<button id="panelEdit">パネル編集</button>
</div>

<canvas id="canvas"></canvas>

<script>
/* ===== DOM ===== */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const upload = document.getElementById("upload");
const colsInput = document.getElementById("cols");
const rowsInput = document.getElementById("rows");
const total = document.getElementById("total");
const panelBuild = document.getElementById("panelBuild");
const panelEdit = document.getElementById("panelEdit");

/* ===== 状態 ===== */
let img = new Image();
let cols=4, rows=4;
let mode="edit";

let hLines=[]; // 横線
let vLines=[]; // 縦線
let panelVisible=[];
let panelPaths=[];

let drag=null;

const MAX=900;
const HIT=14;

/* ===== 数値 ===== */
colsInput.oninput = rowsInput.oninput = ()=>{
  total.textContent = colsInput.value * rowsInput.value;
};

/* ===== 画像 ===== */
upload.onchange=e=>{
  const r=new FileReader();
  r.onload=ev=>img.src=ev.target.result;
  r.readAsDataURL(e.target.files[0]);
};

img.onload=()=>{
  const s=Math.min(MAX/img.width,MAX/img.height);
  canvas.width=img.width*s;
  canvas.height=img.height*s;
  initGrid();
};

/* ===== グリッド初期化 ===== */
function initGrid(){
  cols=+colsInput.value;
  rows=+rowsInput.value;
  total.textContent=cols*rows;

  hLines=[];
  vLines=[];
  panelVisible=[];
  panelPaths=[];

  for(let y=0;y<=rows;y++){
    hLines[y]=[];
    for(let x=0;x<cols;x++){
      hLines[y][x]={dx:0,dy:0};
    }
  }
  for(let x=0;x<=cols;x++){
    vLines[x]=[];
    for(let y=0;y<rows;y++){
      vLines[x][y]={dx:0,dy:0};
    }
  }

  for(let i=0;i<cols*rows;i++) panelVisible[i]=true;
  draw();
}

/* ===== パネル生成 ===== */
panelBuild.onclick=()=>{
  mode="play";
  panelPaths=[];
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      panelPaths.push(makePanelPath(x,y));
    }
  }
  draw();
};

/* ===== 編集に戻る ===== */
panelEdit.onclick=()=>{
  mode="edit";
  panelVisible.fill(true);
  panelPaths=[];
  draw();
};

/* ===== 描画 ===== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(img.src) ctx.drawImage(img,0,0,canvas.width,canvas.height);

  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      const i=y*cols+x;
      if(!panelVisible[i]) continue;
      const path = (mode==="play") ? panelPaths[i] : makePanelPath(x,y);
      ctx.fillStyle="rgba(0,0,0,0.7)";
      ctx.fill(path);
      ctx.strokeStyle="#0ff";
      ctx.stroke(path);
    }
  }
}

/* ===== パネルPath（核心） ===== */
function makePanelPath(x,y){
  const w=canvas.width/cols;
  const h=canvas.height/rows;
  const x0=x*w, y0=y*h;
  const x1=x0+w, y1=y0+h;

  const p=new Path2D();
  p.moveTo(x0,y0);

  // 上
  p.quadraticCurveTo(
    x0+w/2+hLines[y][x].dx,
    y0+hLines[y][x].dy,
    x1,y0
  );
  // 右
  p.quadraticCurveTo(
    x1+vLines[x+1][y].dx,
    y0+h/2+vLines[x+1][y].dy,
    x1,y1
  );
  // 下
  p.quadraticCurveTo(
    x0+w/2+hLines[y+1][x].dx,
    y1+hLines[y+1][x].dy,
    x0,y1
  );
  // 左
  p.quadraticCurveTo(
    x0+vLines[x][y].dx,
    y0+h/2+vLines[x][y].dy,
    x0,y0
  );
  p.closePath();
  return p;
}

/* ===== ポインタ ===== */
canvas.onpointerdown=e=>{
  if(mode!=="edit") return;
  const r=canvas.getBoundingClientRect();
  const px=(e.clientX-r.left)*(canvas.width/r.width);
  const py=(e.clientY-r.top)*(canvas.height/r.height);

  const w=canvas.width/cols;
  const h=canvas.height/rows;

  for(let y=0;y<=rows;y++){
    for(let x=0;x<cols;x++){
      const ly=y*h;
      if(Math.abs(py-ly)<HIT) drag={t:"h",y,x};
    }
  }
  for(let x=0;x<=cols;x++){
    for(let y=0;y<rows;y++){
      const lx=x*w;
      if(Math.abs(px-lx)<HIT) drag={t:"v",x,y};
    }
  }
};

canvas.onpointermove=e=>{
  if(!drag) return;
  const r=canvas.getBoundingClientRect();
  const px=(e.clientX-r.left)*(canvas.width/r.width);
  const py=(e.clientY-r.top)*(canvas.height/r.height);

  if(drag.t==="h"){
    const base=drag.y*(canvas.height/rows);
    hLines[drag.y][drag.x].dy = Math.max(-40,Math.min(40,py-base));
  }
  if(drag.t==="v"){
    const base=drag.x*(canvas.width/cols);
    vLines[drag.x][drag.y].dx = Math.max(-40,Math.min(40,px-base));
  }
  draw();
};

canvas.onpointerup=()=>drag=null;

/* ===== 再生判定 ===== */
canvas.onclick=e=>{
  if(mode!=="play") return;
  const r=canvas.getBoundingClientRect();
  const px=(e.clientX-r.left)*(canvas.width/r.width);
  const py=(e.clientY-r.top)*(canvas.height/r.height);

  panelPaths.forEach((p,i)=>{
    if(panelVisible[i] && ctx.isPointInPath(p,px,py)){
      panelVisible[i]=false;
      draw();
    }
  });
};
</script>
</body>
</html>
