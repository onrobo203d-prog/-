<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>パネル開けエディタ</title>

<style>
body{margin:0;font-family:sans-serif;background:#f4f4f4;text-align:center;}
#topbar{padding:10px;background:#222;color:#fff;}
button,input{margin:5px;}
#canvasWrapper{position:relative;display:inline-block;}
canvas{touch-action:none;border:1px solid #999;}
.modal{
 position:fixed;inset:0;background:rgba(0,0,0,.6);
 display:flex;align-items:center;justify-content:center;
}
.modalContent{
 background:#fff;padding:20px;border-radius:10px;
}
.hidden{display:none;}
.panelForm{
 position:fixed;right:0;top:0;background:#fff;
 padding:10px;border-left:2px solid #ccc;
}
</style>
</head>
<body>

<div id="topbar">
<input type="file" id="imageLoader" accept="image/*">
<label>線の太さ</label>
<input type="range" id="lineWidth" min="1" max="20" value="3">
<button id="previewBtn">進捗</button>
<button id="undoBtn">戻る</button>
<button id="exportBtn">外部保存</button>
<button id="importBtn">読み込み</button>
<input type="file" id="importFile" accept=".json" hidden>
</div>

<div id="canvasWrapper">
<canvas id="canvas"></canvas>
</div>

<!-- 起動モーダル -->
<div id="startupModal" class="modal hidden">
 <div class="modalContent">
  <h3>前回データがあります</h3>
  <button id="restoreBtn">復旧</button>
  <button id="newBtn">新規作成</button>
  <button id="importStartupBtn">外部読込</button>
 </div>
</div>

<script>
const STORAGE_KEY="panelPuzzleSave_v1";

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const image=new Image();

let panels=[];
let drawing=false;
let currentPoints=[];
let selectedPanel=null;

const lineWidthSlider=document.getElementById("lineWidth");

function resizeCanvas(){
 canvas.width=image.width;
 canvas.height=image.height;
 redraw();
}

function redraw(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 if(image.src) ctx.drawImage(image,0,0);

 panels.forEach(p=>{
  if(!p.unlocked){
   ctx.fillStyle=p.color;
   ctx.fill(p.path);
   ctx.fillStyle=p.textColor;
   ctx.font="16px sans-serif";
   ctx.textAlign="center";
   const b=p.points[0];
   ctx.fillText(p.name,b.x,b.y);
  }
 });

 if(drawing && currentPoints.length>1){
  ctx.strokeStyle="red";
  ctx.lineWidth=lineWidthSlider.value;
  ctx.beginPath();
  ctx.moveTo(currentPoints[0].x,currentPoints[0].y);
  currentPoints.forEach(pt=>ctx.lineTo(pt.x,pt.y));
  ctx.stroke();
 }
}

function createPath(points){
 const path=new Path2D();
 path.moveTo(points[0].x,points[0].y);
 points.forEach(pt=>path.lineTo(pt.x,pt.y));
 path.closePath();
 return path;
}

canvas.addEventListener("pointerdown",e=>{
 if(!image.src) return;
 drawing=true;
 currentPoints=[{x:e.offsetX,y:e.offsetY}];
});

canvas.addEventListener("pointermove",e=>{
 if(!drawing) return;
 currentPoints.push({x:e.offsetX,y:e.offsetY});
 redraw();
});

canvas.addEventListener("pointerup",()=>{
 if(!drawing) return;
 drawing=false;
 if(currentPoints.length>2){
  const panel={
   id:Date.now(),
   name:"パネル",
   condition:"",
   color:"#000000",
   textColor:"#ffffff",
   unlocked:false,
   points:currentPoints,
   path:createPath(currentPoints)
  };
  panels.push(panel);
  saveToStorage();
 }
 currentPoints=[];
 redraw();
});

canvas.addEventListener("click",e=>{
 panels.forEach(p=>{
  if(ctx.isPointInPath(p.path,e.offsetX,e.offsetY)){
   p.unlocked=!p.unlocked;
   saveToStorage();
  }
 });
 redraw();
});

document.getElementById("undoBtn").onclick=()=>{
 panels.pop();
 saveToStorage();
 redraw();
};

document.getElementById("previewBtn").onclick=()=>{
 const u=panels.filter(p=>p.unlocked).length;
 alert(`進捗 ${u}/${panels.length}`);
};

document.getElementById("imageLoader").addEventListener("change",function(){
 const reader=new FileReader();
 reader.onload=e=>{
  image.src=e.target.result;
 };
 reader.readAsDataURL(this.files[0]);
});

image.onload=()=>{
 resizeCanvas();
 saveToStorage();
};

function saveToStorage(){
 const data={
  image:image.src,
  panels:panels.map(p=>({
   ...p,
   path:null
  }))
 };
 localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
}

function loadFromStorage(){
 const saved=JSON.parse(localStorage.getItem(STORAGE_KEY));
 if(!saved) return;
 image.src=saved.image;
 panels=saved.panels.map(p=>({
  ...p,
  path:createPath(p.points)
 }));
}

document.getElementById("exportBtn").onclick=()=>{
 const blob=new Blob(
  [localStorage.getItem(STORAGE_KEY)],
  {type:"application/json"}
 );
 const url=URL.createObjectURL(blob);
 const a=document.createElement("a");
 a.href=url;
 a.download="panelSave.json";
 a.click();
 URL.revokeObjectURL(url);
};

document.getElementById("importBtn").onclick=()=>{
 document.getElementById("importFile").click();
};

document.getElementById("importStartupBtn").onclick=()=>{
 document.getElementById("importFile").click();
};

document.getElementById("importFile").addEventListener("change",function(){
 const reader=new FileReader();
 reader.onload=e=>{
  localStorage.setItem(STORAGE_KEY,e.target.result);
  location.reload();
 };
 reader.readAsText(this.files[0]);
});

document.getElementById("restoreBtn").onclick=()=>{
 document.getElementById("startupModal").classList.add("hidden");
 loadFromStorage();
};

document.getElementById("newBtn").onclick=()=>{
 localStorage.removeItem(STORAGE_KEY);
 location.reload();
};

window.onload=()=>{
 if(localStorage.getItem(STORAGE_KEY)){
  document.getElementById("startupModal").classList.remove("hidden");
 }
};
</script>

</body>
</html>
